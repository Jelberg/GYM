-----------------FIN CREAR LA BASE DE DATOS CON USER---------------

CREATE 	USER 	 gymucab 	PASSWORD 'gymucab';
ALTER 	ROLE	 gymucab 	WITH SUPERUSER;
CREATE 	DATABASE gimnasiobd 	WITH OWNER gymucab;


 -------------CREATES TABLAS DE LA BASE DE DATOS ORDENADA-----------

CREATE TABLE USUARIO(
	USU_ID                  	SERIAL ,
	USU_CEDULA                  	INTEGER NOT NULL,
	USU_NOMBRE                	VARCHAR(10) NOT NULL,
	USU_APELLIDO               	VARCHAR(10) NOT NULL,
	USU_SEXO           		CHAR NOT NULL,
	USU_FECHA_NAC          		DATE NOT NULL,
	USU_TELEFONO			VARCHAR(15) NOT NULL,
	USU_ESTATURA			INTEGER,
	USU_FOTO			BYTEA,
	USU_CORREO			VARCHAR(30) NOT NULL,
CONSTRAINT PK_USU_ID PRIMARY KEY (USU_ID)
);

CREATE TABLE USUARIO_AMIGO(
  	AMI_USUARIO INTEGER,
  	AMI_AMIGO INTEGER,
  CONSTRAINT USUARIO_AMIGO_AMI_AMIGO_FKEY FOREIGN KEY (AMI_AMIGO) REFERENCES USUARIO (USU_ID) MATCH SIMPLE ON UPDATE NO ACTION ON DELETE NO ACTION,
  CONSTRAINT USUARIO_AMIGO_AMI_USUARIO_FKEY FOREIGN KEY (AMI_USUARIO) REFERENCES USUARIO (USU_ID) MATCH SIMPLE ON UPDATE NO ACTION ON DELETE NO ACTION
);


CREATE TABLE ENTRENADOR(
	ENT_ID serial not null,
	ENT_nombre character varying (50) not null,
	ENT_apellido character varying (50) not null,
	ENT_fecha_nac date not null,
	ENT_sexo char not null,
	ENT_correo character varying (100) not null unique,
	ENT_historial character varying (200) not null,
	ENT_foto bytea,
CONSTRAINT PK_ENT_ID PRIMARY KEY (ENT_ID)	
);

CREATE TABLE USUARIO_ENTRENADOR(
	FK_USUARIO		INTEGER NOT NULL,
	FK_ENTRENADOR	INTEGER NOT NULL,
CONSTRAINT PK_UE_ID PRIMARY KEY (FK_USUARIO, FK_ENTRENADOR),
CONSTRAINT FK_USUARIO  FOREIGN KEY(FK_USUARIO) REFERENCES USUARIO(USU_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FK_ENTRENADOR  FOREIGN KEY(FK_ENTRENADOR) REFERENCES ENTRENADOR(ENT_ID) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE TURNO(
	TUR_ID serial not null,
	TUR_DIA character varying (15) not null,
CONSTRAINT PK_TUR_ID PRIMARY KEY (TUR_ID)	
);

CREATE TABLE TURNO_ENTRENADOR(
	TE_ID                           SERIAL NOT NULL,
	TE_FECHA           		DATE NOT NULL,
	TE_TANDA			CHARACTER VARYING(10) NOT NULL,
	TE_HORA_INICIO   		TIME NOT NULL,
	TE_HORA_FIN                 	TIME NOT NULL,
	FK_TURNO                  	INTEGER,
    FK_ENTRENADOR				INTEGER,
CONSTRAINT FK_TURNO  FOREIGN KEY(FK_TURNO) REFERENCES TURNO(TUR_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_ENTRENADOR  FOREIGN KEY(FK_ENTRENADOR) REFERENCES ENTRENADOR(ENT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_TE_ID PRIMARY KEY (TE_ID)
);

CREATE TABLE PLAN(	
	PLA_ID	SERIAL NOT NULL,	
	PLA_NOMBRE	VARCHAR(30) NOT NULL,    
	PLA_DESCRIPCION	VARCHAR(100),   
	FK_USUARIO	INTEGER,   
CONSTRAINT FK_USUARIO_PLAN  FOREIGN KEY(FK_USUARIO) REFERENCES USUARIO(USU_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_PLA_ID PRIMARY KEY (PLA_ID)
);

CREATE TABLE RUTINA(
	RUT_ID                          SERIAL NOT NULL,
	RUT_NOMBRE           		VARCHAR(10) NOT NULL,
	RUT_DIA              		VARCHAR(10),
	RUT_ESTADO			BOOLEAN,
	FK_USUARIO                   	INTEGER,
	FK_USUARIO_ENTRENADOR           INTEGER,
	FK_PLAN                         INTEGER,
CONSTRAINT FK_USUARIO_RUTINA  FOREIGN KEY(FK_USUARIO) REFERENCES USUARIO(USU_ID) ON DELETE CASCADE ON UPDATE CASCADE,
--CONSTRAINT FK_USUARIO_ENTRENADOR_RUT  FOREIGN KEY(FK_USUARIO_ENTRENADOR) REFERENCES ENTRENADOR(ENT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT NOMBRE_RUTINA_UNICO UNIQUE(RUT_NOMBRE, FK_USUARIO, RUT_DIA),
CONSTRAINT FK_RUTINA_PLAN FOREIGN KEY (FK_PLAN) REFERENCES PLAN (PLA_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_RUT_ID PRIMARY KEY (RUT_ID)
);

CREATE TABLE EJERCICIO(
	EJE_ID                           SERIAL NOT NULL,
	EJE_NOMBRE           		VARCHAR(20) NOT NULL,
	EJE_GRUPO_MUSCULAR			VARCHAR(20) NOT NULL,
CONSTRAINT PK_EJE_ID PRIMARY KEY (EJE_ID)
);

CREATE TABLE EQUIPO(
	EQU_ID                           SERIAL NOT NULL,
	EQU_NOMBRE           		VARCHAR(20) NOT NULL,
CONSTRAINT PK_EQU_ID PRIMARY KEY (EQU_ID)
);

CREATE TABLE MAQUINA(
	MAQ_ID                           SERIAL NOT NULL,
	MAQ_NOMBRE           		VARCHAR(20) NOT NULL,
CONSTRAINT PK_MAQ_ID PRIMARY KEY (MAQ_ID)
);

CREATE TABLE EJERCICIO_MAQUINA_EQUIPO(
	EME_ID                           SERIAL NOT NULL,
	FK_MAQUINA           		INTEGER,
	FK_EJERCICIO              	INTEGER NOT NULL,
	FK_EQUIPO           	 INTEGER,
	FK_RUTINA                INTEGER,
CONSTRAINT FK_MAQ  FOREIGN KEY(FK_MAQUINA) REFERENCES MAQUINA(MAQ_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FK_EJE  FOREIGN KEY(FK_EJERCICIO) REFERENCES EJERCICIO(EJE_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FK_EQU  FOREIGN KEY(FK_EQUIPO) REFERENCES EQUIPO(EQU_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FK_RUT  FOREIGN KEY(FK_RUTINA) REFERENCES RUTINA(RUT_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_EME_ID PRIMARY KEY (EME_ID, FK_EJERCICIO)
);
 ALTER TABLE EJERCICIO_MAQUINA_EQUIPO ADD COLUMN EME_TIPO BOOLEAN;

CREATE TABLE TRABAJO_RUTINA(
	TR_ID                           SERIAL NOT NULL,
	TR_FECHA           		DATE NOT NULL,
	TR_DESCANSO             DECIMAL,
	TR_DURACION             INTEGER,
	TR_DISTANCIA            INTEGER,
	TR_NIVEL                INTEGER,
	FK_EJE_MAQ_EQU1          INTEGER NOT NULL,
	FK_EJE_MAQ_EQU2          INTEGER NOT NULL,
CONSTRAINT FK_EJE_MAQ_EQU_RUT  FOREIGN KEY(FK_EJE_MAQ_EQU1, FK_EJE_MAQ_EQU2) REFERENCES EJERCICIO_MAQUINA_EQUIPO(EME_ID, FK_EJERCICIO) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_TR_ID PRIMARY KEY (TR_ID)
);
ALTER TABLE  Trabajo_rutina ALTER COLUMN tr_fecha  DROP  NOT NULL
CREATE TABLE SERIE(
	SER_ID                 SERIAL NOT NULL,
	SER_PESO           	   DECIMAL NOT NULL,
	SER_UNIDAD             VARCHAR(2),
	SER_REPETICION         INTEGER,
	FK_TRABAJO_RUTINA      INTEGER NOT NULL,
CONSTRAINT FK_TRABAJO_RUTINA_SER  FOREIGN KEY(FK_TRABAJO_RUTINA) REFERENCES TRABAJO_RUTINA(TR_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_SER_ID PRIMARY KEY (SER_ID,FK_TRABAJO_RUTINA)
);

CREATE TABLE INSTRUCTOR
(
 	INS_ID                  	SERIAL NOT NULL,
 	INS_NOMBRE                 	CHARACTER VARYING(10) NOT NULL,
 	INS_APELLIDO                	CHARACTER VARYING(10) NOT NULL,
 	INS_FECHA_NAC   DATE NOT NULL,
 	INS_SEXO            	CHARACTER(1) NOT NULL,
 	INS_CORREO                 	CHARACTER VARYING(20) NOT NULL UNIQUE,
 	INS_FOTO            	BYTEA,
 CONSTRAINT INSTRUCTOR_PKEY PRIMARY KEY (INS_ID)
);
 
CREATE TABLE CLASE
(
 	CLA_ID                 	SERIAL NOT NULL,
 	CLA_NOMBRE                	CHARACTER VARYING(10) NOT NULL UNIQUE,
 	CLA_DESCRIPCION       	CHARACTER VARYING(300) NOT NULL,
 CONSTRAINT CLASE_PKEY PRIMARY KEY (CLA_ID)
);
 
CREATE TABLE HORARIO_CLASE(
	HC_ID                           SERIAL NOT NULL,
	HC_FECHA           		DATE NOT NULL,
	HC_DIA			CHARACTER VARYING(10) NOT NULL,
	HC_CAPACIDAD              	INTEGER  NOT NULL,
	HC_HORA_INICIO   		TIME NOT NULL,
	HC_HORA_FIN                 	TIME NOT NULL,
	HC_STATUS			CHARACTER(1) NOT NULL,
	HC_DURACION               	TIME,
	FK_USUARIO                   	INTEGER,
	FK_INSTRUCTOR           	INTEGER ,
	FK_CLASE            		INTEGER ,
CONSTRAINT FK_USUARIO  FOREIGN KEY(FK_USUARIO) REFERENCES USUARIO(USU_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_INSTRUCTOR  FOREIGN KEY(FK_INSTRUCTOR) REFERENCES INSTRUCTOR(INS_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_CLASE_USUARIO  FOREIGN KEY(FK_CLASE) REFERENCES CLASE(CLA_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_HC_ID PRIMARY KEY (HC_ID)
);

CREATE TABLE RESERVA_CLASE(
	RC_ID                           SERIAL NOT NULL,
	FK_HC_ID           		INTEGER,
	FK_USUARIO           		INTEGER,
CONSTRAINT FK_USUARIO  FOREIGN KEY(FK_USUARIO) REFERENCES USUARIO(USU_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT FK_HC_ID  FOREIGN KEY(FK_HC_ID) REFERENCES HORARIO_CLASE(HC_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_RC_ID PRIMARY KEY (RC_ID)
);

CREATE TABLE CRITICA(
	CRI_ID			SERIAL NOT NULL,
	CRI_FECHA		DATE NOT NULL,
	CRI_COMENTARIO		CHARACTER VARYING(400),
	CRI_VALORACION		INTEGER,
	FK_HC_ID		INTEGER,
CONSTRAINT FK_HC_ID FOREIGN KEY (FK_HC_ID) REFERENCES HORARIO_CLASE(HC_ID) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT PK_CRI_ID PRIMARY KEY (CRI_ID)
);

CREATE TABLE MEDIDA(
	med_id		serial  not null,
	med_tipo	varchar(20) unique not null,
CONSTRAINT pk_med_id PRIMARY KEY (med_id)
);

CREATE TABLE PROGRESO_MEDIDA(
	pm_id		serial not null,
	pm_medida	integer,
	pm_fecha	date not null,
	fk_usuario	integer,
	fk_medida	integer,
CONSTRAINT pk_pm_id PRIMARY KEY (pm_id),
CONSTRAINT fk_usuario  FOREIGN KEY(fk_usuario) REFERENCES usuario(usu_id) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT fk_medida  FOREIGN KEY(fk_medida) REFERENCES medida(med_id) ON DELETE CASCADE ON UPDATE CASCADE	
);

CREATE TABLE PROGRESO_PESO(
	pp_id		serial not null,
	pp_peso		integer,	
	pp_fecha	date not null,
	fk_usuario	integer not null,
CONSTRAINT pk_pp_id PRIMARY KEY (pp_id),
CONSTRAINT fk_usuario  FOREIGN KEY(fk_usuario) REFERENCES usuario(usu_id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE COMENTARIO(
	com_id		serial not null,
	com_mensaje	varchar(80),
	com_fecha date,
	fk_usuario	integer not null,	
CONSTRAINT pk_com_id PRIMARY KEY (com_id),
CONSTRAINT fk_usuario  FOREIGN KEY(fk_usuario) REFERENCES usuario(usu_id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE INTERACCION_COMENTARIO(
	id		serial not null,
	mensaje		varchar(140),
	fk_usuario	integer not null,
	fk_progreso	integer not null,
	
CONSTRAINT pk_interac PRIMARY KEY (id),
CONSTRAINT fk_usuario  FOREIGN KEY(fk_usuario) REFERENCES usuario(usu_id) ON DELETE CASCADE ON UPDATE CASCADE,
CONSTRAINT fk_com  FOREIGN KEY(fk_progreso) REFERENCES comentario(com_id) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE RESERVA(
	RES_ID					SERIAL NOT NULL,
	RES_FECHA_INI			DATE NOT NULL,	
	RES_FECHA_FIN			DATE NOT NULL,
	FK_USUARIO				INTEGER NOT NULL,
	FK_ENTRENADOR			INTEGER NOT NULL,
CONSTRAINT PK_RES_ID PRIMARY KEY (RES_ID),
CONSTRAINT FK_USUARIO  FOREIGN KEY(FK_USUARIO,FK_ENTRENADOR) REFERENCES USUARIO_ENTRENADOR(FK_USUARIO,FK_ENTRENADOR) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE MENSAJE(
	MES_ID					SERIAL NOT NULL,
	MES_MENSAJE				VARCHAR(250) NOT NULL,	
	FK_USUARIO				INTEGER NOT NULL,
	FK_ENTRENADOR			INTEGER NOT NULL,
CONSTRAINT PK_MES_ID PRIMARY KEY (MES_ID),
CONSTRAINT FK_USUARIO  FOREIGN KEY(FK_USUARIO,FK_ENTRENADOR) REFERENCES USUARIO_ENTRENADOR(FK_USUARIO,FK_ENTRENADOR) ON DELETE CASCADE ON UPDATE CASCADE
);

CREATE TABLE PROGRESO_RUTINA(
	PR_ID		SERIAL NOT NULL,
	PR_PROGRESO		VARCHAR(50) NOT NULL,	
	PR_EVALUACION		VARCHAR(50) NOT NULL,
	FK_RUTINA	INTEGER NOT NULL,
CONSTRAINT PK_PR_ID PRIMARY KEY (PR_ID),
CONSTRAINT FK_RUTINA  FOREIGN KEY(FK_RUTINA) REFERENCES RUTINA(RUT_ID) ON DELETE CASCADE ON UPDATE CASCADE
);

 -----------FIN DE CREATES TABLAS DE LA BASE DE DATOS ORDENADA----------

--------- INICIO ALTER-------
ALTER TABLE CRITICA
ADD COLUMN CRI_ID_USUARIO INTEGER;
